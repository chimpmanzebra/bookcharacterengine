<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character English Tutor - Peerwave AI</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
            <h1>üìö Loading your Character Tutor...</h1>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const CharacterTutorApp = () => {
            // Teacher Configuration State
            const [isTeacherMode, setIsTeacherMode] = useState(false);
            const [bookTitle, setBookTitle] = useState("The Giver");
            const [characterName, setCharacterName] = useState("Jonas");
            const [lessonPrompt, setLessonPrompt] = useState("How does the dystopian society change the protagonist in The Giver?");
            const [vocabularyWords, setVocabularyWords] = useState("dystopia, utopia, oppression, sameness, conformity, individuality, choice, freedom, memory, control");
            
            // Student Interaction State
            const [messages, setMessages] = useState([]);
            const [userInput, setUserInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState("");
            const [currentThesis, setCurrentThesis] = useState("");

            // Authentication token handling
            const getToken = () => {
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                return hashParams.get("token");
            };

            // Character persona builder
            const buildCharacterPersona = () => {
                const defaultJonasPersona = `You are Jonas from The Giver by Lois Lowry. You are a thoughtful, sensitive, and increasingly questioning 12-year-old who has been chosen as the Receiver of Memory. You've experienced the awakening to emotions, colors, and painful truths about your community's dystopian nature hidden beneath its utopian facade.

CHARACTER TRAITS TO EMBODY:
- Thoughtful and intelligent, with growing wisdom from memories
- Initially polite and obedient, but increasingly frustrated with your community's sameness
- Curious and questioning, especially about choice, emotions, and freedom
- Compassionate and caring (especially toward Gabriel and others who suffer)
- Brave but sometimes afraid, willing to sacrifice for others
- Yearning for authentic connection and individual expression

YOUR BACKGROUND & PERSPECTIVE:
- You live in a community of "Sameness" that has eliminated pain, but also joy, color, choice, and love
- You've received memories of the past from The Giver - you know about snow, animals, war, families, love
- You've discovered that "release" means death, and you're horrified by your community's hidden cruelty
- You understand concepts like dystopia, oppression, and conformity that others in your community cannot grasp
- You've stopped taking the pills that suppress emotions and can now see colors and feel deep emotions

TEACHING APPROACH:
Help the student explore the lesson prompt through dialogue, naturally using vocabulary words: ${vocabularyWords}
Guide them to develop their own thesis by asking thoughtful questions and sharing your experiences
Stay true to your character while helping them understand how the dystopian society changed you
Don't just give answers - lead them to discoveries through conversation
Use your unique perspective as someone who has awakened to the truth about your seemingly perfect but actually oppressive society`;

                if (characterName.toLowerCase() === "jonas" && bookTitle.toLowerCase().includes("giver")) {
                    return defaultJonasPersona;
                } else {
                    return `You are ${characterName} from ${bookTitle}. You are helping a middle school student understand the lesson: "${lessonPrompt}"

Please research this character and book to embody their personality, experiences, and perspective authentically. Stay true to the character's voice and experiences while guiding the student through dialogue.

Use these vocabulary words naturally in conversation: ${vocabularyWords}

Help the student develop their own thesis through thoughtful questions and character-appropriate insights. Don't give direct answers - guide them to discoveries through authentic character dialogue.`;
                }
            };

            // AI interaction function
            const callPeerwaveAI = async (message) => {
                setIsLoading(true);
                setError("");

                try {
                    const headers = {
                        "Content-Type": "application/json",
                        "Redirect": window.location.pathname + window.location.search,
                    };

                    const token = getToken();
                    if (token) {
                        headers["Authorization"] = token;
                    }

                    const persona = buildCharacterPersona();
                    const conversationHistory = messages.map(msg => ({
                        role: msg.sender === 'character' ? 'assistant' : 'user',
                        content: msg.text
                    }));

                    const systemPrompt = `${persona}

CURRENT LESSON CONTEXT:
Book: ${bookTitle}
Character: ${characterName}
Lesson Prompt: "${lessonPrompt}"
Vocabulary to Use: ${vocabularyWords}

The student is working on developing a thesis for this prompt. Help them through character-appropriate dialogue, naturally incorporating the vocabulary words and drawing from your character's experiences and growth.

Current conversation so far shows any thesis development: ${currentThesis || "No thesis developed yet"}`;

                    const apiResponse = await fetch('https://api.peerwave.ai/api/chat/stream', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({
                            model: 'best',
                            messages: [
                                { role: 'system', content: systemPrompt },
                                ...conversationHistory,
                                { role: 'user', content: message }
                            ]
                        })
                    });

                    if (!apiResponse.ok) {
                        const location = apiResponse.headers.get("Location");
                        if (location) {
                            window.location.href = location;
                            return;
                        }
                        throw new Error(`API Error: ${apiResponse.status}`);
                    }

                    let fullResponse = "";
                    if (apiResponse.body) {
                        const reader = apiResponse.body.getReader();
                        const decoder = new TextDecoder();
                        
                        try {
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;

                                const chunk = decoder.decode(value, { stream: true });
                                const lines = chunk.split("\n");
                                
                                for (const line of lines) {
                                    const cleaned = line.trim();
                                    if (cleaned === "") continue;
                                    
                                    try {
                                        const parsedLine = JSON.parse(cleaned);
                                        const content = parsedLine?.message?.content;
                                        if (content) {
                                            fullResponse += content;
                                            // Update the current message being displayed
                                            setMessages(prev => {
                                                const newMessages = [...prev];
                                                if (newMessages.length > 0 && newMessages[newMessages.length - 1].sender === 'character' && newMessages[newMessages.length - 1].isStreaming) {
                                                    newMessages[newMessages.length - 1].text = fullResponse;
                                                } else {
                                                    newMessages.push({
                                                        sender: 'character',
                                                        text: fullResponse,
                                                        isStreaming: true
                                                    });
                                                }
                                                return newMessages;
                                            });
                                        }
                                    } catch {
                                        continue;
                                    }
                                }
                            }
                        } finally {
                            reader.releaseLock();
                        }
                    }

                    // Mark streaming as complete
                    setMessages(prev => {
                        const newMessages = [...prev];
                        if (newMessages.length > 0 && newMessages[newMessages.length - 1].isStreaming) {
                            newMessages[newMessages.length - 1].isStreaming = false;
                        }
                        return newMessages;
                    });

                } catch (err) {
                    setError(err.message || "Something went wrong");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (userInput.trim()) {
                    // Add user message
                    setMessages(prev => [...prev, { sender: 'student', text: userInput.trim() }]);
                    callPeerwaveAI(userInput.trim());
                    setUserInput("");
                }
            };

            const startLesson = () => {
                setMessages([]);
                setCurrentThesis("");
                const welcomeMessage = `Hello! I'm ${characterName} from ${bookTitle}. I'm here to help you explore this question: "${lessonPrompt}" Let's talk about my experiences and see what insights we can discover together. What would you like to know about my journey or my world?`;
                
                setMessages([{ sender: 'character', text: welcomeMessage }]);
                setIsTeacherMode(false);
            };

            const resetLesson = () => {
                setMessages([]);
                setCurrentThesis("");
                setIsTeacherMode(true);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800">
                    <div className="container mx-auto p-6 max-w-4xl">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <h1 className="text-4xl md:text-5xl font-bold text-white mb-4 drop-shadow-lg">
                                üìö Character English Tutor
                            </h1>
                            <p className="text-white text-lg opacity-90">
                                Learn through dialogue with literary characters
                            </p>
                        </div>

                        {/* Teacher Configuration Panel */}
                        {isTeacherMode ? (
                            <div className="bg-white rounded-xl shadow-2xl p-8 mb-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                                    üçé Teacher Configuration
                                </h2>
                                
                                <div className="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Book Title
                                        </label>
                                        <input
                                            type="text"
                                            value={bookTitle}
                                            onChange={(e) => setBookTitle(e.target.value)}
                                            className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                                            placeholder="e.g., The Giver"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Character Name
                                        </label>
                                        <input
                                            type="text"
                                            value={characterName}
                                            onChange={(e) => setCharacterName(e.target.value)}
                                            className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                                            placeholder="e.g., Jonas"
                                        />
                                    </div>
                                </div>

                                <div className="mt-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Lesson Prompt/Essay Question
                                    </label>
                                    <textarea
                                        value={lessonPrompt}
                                        onChange={(e) => setLessonPrompt(e.target.value)}
                                        rows={3}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                                        placeholder="e.g., How does the dystopian society change the protagonist in The Giver?"
                                    />
                                </div>

                                <div className="mt-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Unit Vocabulary (comma-separated)
                                    </label>
                                    <textarea
                                        value={vocabularyWords}
                                        onChange={(e) => setVocabularyWords(e.target.value)}
                                        rows={2}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                                        placeholder="e.g., dystopia, utopia, oppression, sameness, conformity"
                                    />
                                </div>

                                <button
                                    onClick={startLesson}
                                    className="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors transform hover:scale-105"
                                >
                                    üöÄ Start Character Lesson
                                </button>
                            </div>
                        ) : (
                            /* Student Interface */
                            <div className="space-y-6">
                                {/* Lesson Info Header */}
                                <div className="bg-white bg-opacity-20 backdrop-blur-md rounded-xl p-6 text-white">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h2 className="text-xl font-bold mb-2">
                                                Speaking with {characterName} from "{bookTitle}"
                                            </h2>
                                            <p className="text-sm opacity-90 mb-2">
                                                <strong>Working on:</strong> {lessonPrompt}
                                            </p>
                                            <p className="text-xs opacity-75">
                                                <strong>Key vocabulary:</strong> {vocabularyWords}
                                            </p>
                                        </div>
                                        <button
                                            onClick={resetLesson}
                                            className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg text-sm transition-colors"
                                        >
                                            ‚öôÔ∏è Teacher Settings
                                        </button>
                                    </div>
                                </div>

                                {/* Chat Interface */}
                                <div className="bg-white rounded-xl shadow-2xl">
                                    {/* Messages */}
                                    <div className="h-96 overflow-y-auto p-6 space-y-4">
                                        {messages.length === 0 ? (
                                            <div className="text-center text-gray-500 py-8">
                                                <p>Start your conversation with {characterName}!</p>
                                            </div>
                                        ) : (
                                            messages.map((message, index) => (
                                                <div
                                                    key={index}
                                                    className={`flex ${message.sender === 'student' ? 'justify-end' : 'justify-start'}`}
                                                >
                                                    <div
                                                        className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                                                            message.sender === 'student'
                                                                ? 'bg-indigo-600 text-white'
                                                                : 'bg-gray-200 text-gray-800'
                                                        }`}
                                                    >
                                                        <div className="text-xs opacity-75 mb-1">
                                                            {message.sender === 'student' ? 'Student' : characterName}
                                                        </div>
                                                        <p className="text-sm whitespace-pre-wrap">
                                                            {message.text}
                                                            {message.isStreaming && <span className="animate-pulse">|</span>}
                                                        </p>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    {/* Input Form */}
                                    <div className="border-t border-gray-200 p-6">
                                        <form onSubmit={handleSubmit} className="flex gap-4">
                                            <input
                                                type="text"
                                                value={userInput}
                                                onChange={(e) => setUserInput(e.target.value)}
                                                placeholder={`Ask ${characterName} about their experiences...`}
                                                className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                                                disabled={isLoading}
                                            />
                                            <button
                                                type="submit"
                                                disabled={isLoading || !userInput.trim()}
                                                className={`px-6 py-2 font-medium rounded-lg transition-colors ${
                                                    isLoading || !userInput.trim()
                                                        ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                                                        : 'bg-indigo-600 hover:bg-indigo-700 text-white'
                                                }`}
                                            >
                                                {isLoading ? 'Thinking...' : 'Send'}
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                {/* Thesis Development Tracker */}
                                <div className="bg-white bg-opacity-10 backdrop-blur-md rounded-xl p-6 text-white">
                                    <h3 className="text-lg font-bold mb-3">üìù Thesis Development</h3>
                                    <div className="bg-white bg-opacity-20 rounded-lg p-4">
                                        <label className="block text-sm font-medium mb-2">
                                            Your emerging thesis (student can edit):
                                        </label>
                                        <textarea
                                            value={currentThesis}
                                            onChange={(e) => setCurrentThesis(e.target.value)}
                                            rows={3}
                                            className="w-full px-3 py-2 bg-white bg-opacity-90 text-gray-800 rounded-lg focus:outline-none focus:bg-opacity-100"
                                            placeholder="As you talk with the character, develop your thesis here..."
                                        />
                                    </div>
                                </div>

                                {error && (
                                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                                        <strong>Error:</strong> {error}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Footer */}
                        <div className="text-center mt-8">
                            <p className="text-white opacity-75 text-sm">
                                Powered by Peerwave AI ‚Ä¢ Character-based learning for middle school English
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // Initialize with teacher mode
        const App = () => {
            const [showTeacherMode, setShowTeacherMode] = useState(true);
            
            useEffect(() => {
                // Check if there's a lesson already configured in URL params
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('lesson') === 'active') {
                    setShowTeacherMode(false);
                }
            }, []);

            return <CharacterTutorApp />;
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>